// ============================================================
// AquiTa.do â€” Prisma Schema
// ============================================================

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  BUSINESS_OWNER
  ADMIN
}

enum OrganizationRole {
  OWNER
  MANAGER
  STAFF
}

enum OrganizationPlan {
  FREE
  GROWTH
  SCALE
}

enum OrganizationSubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  UNPAID
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELED
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELED
  NO_SHOW
}

enum BookingSource {
  PLATFORM
  DASHBOARD
  IMPORTED
}

enum TransactionStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELED
}

enum WebhookProvider {
  STRIPE
}

enum WebhookProcessingStatus {
  RECEIVED
  PROCESSED
  FAILED
}

enum ConversationStatus {
  OPEN
  CLOSED
  CONVERTED
}

enum MessageSenderRole {
  CUSTOMER
  BUSINESS_STAFF
  SYSTEM
}

enum BusinessTier {
  BRONZE
  SILVER
  GOLD
}

enum ReviewModerationStatus {
  APPROVED
  FLAGGED
}

enum BusinessVerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
  SUSPENDED
}

enum VerificationDocumentType {
  ID_CARD
  TAX_CERTIFICATE
  BUSINESS_LICENSE
  ADDRESS_PROOF
  SELFIE
  OTHER
}

enum VerificationDocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AdCampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  ENDED
  REJECTED
}

enum AdBillingModel {
  CPC
}

enum AdEventType {
  IMPRESSION
  CLICK
  CONVERSION
}

enum MarketReportType {
  PROVINCE_CATEGORY_DEMAND
  TRENDING_BUSINESSES
  CONVERSION_BENCHMARK
}

enum AdWalletTopupStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
}

model User {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(100)
  email     String   @unique @db.VarChar(255)
  password  String
  phone     String?  @db.VarChar(20)
  avatarUrl String?  @db.VarChar(500)
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  businesses               Business[]
  reviews                  Review[]
  organizationsOwned       Organization[]                 @relation("OrganizationOwner")
  organizationMemberships  OrganizationMember[]
  organizationInvitesSent  OrganizationInvite[]           @relation("OrganizationInvitedBy")
  auditLogs                AuditLog[]                     @relation("AuditActor")
  refreshTokens            RefreshToken[]
  bookings                 Booking[]
  promotionsCreated        Promotion[]                    @relation("PromotionCreator")
  transactionsAsBuyer      Transaction[]                  @relation("TransactionBuyer")
  conversationsAsCustomer  Conversation[]                 @relation("ConversationCustomer")
  conversationMessagesSent ConversationMessage[]          @relation("ConversationMessageSender")
  adCampaignsCreated       AdCampaign[]                   @relation("AdCampaignCreator")
  verificationReviews      BusinessVerificationDocument[] @relation("VerificationDocumentReviewer")
  marketReportsGenerated   MarketReportSnapshot[]         @relation("MarketReportGeneratedBy")
  adWalletTopupsRequested  AdWalletTopup[]                @relation("AdWalletTopupRequester")

  @@index([email])
  @@map("users")
}

model Business {
  id                      String                     @id @default(uuid())
  name                    String                     @db.VarChar(200)
  slug                    String                     @unique @db.VarChar(250)
  description             String                     @db.Text
  phone                   String?                    @db.VarChar(20)
  whatsapp                String?                    @db.VarChar(20)
  address                 String                     @db.VarChar(500)
  latitude                Float?
  longitude               Float?
  verified                Boolean                    @default(false)
  verifiedAt              DateTime?
  verificationStatus      BusinessVerificationStatus @default(UNVERIFIED)
  verificationSubmittedAt DateTime?
  verificationReviewedAt  DateTime?
  verificationNotes       String?                    @db.VarChar(500)
  riskScore               Int                        @default(0)
  reputationScore         Decimal                    @default(0) @db.Decimal(6, 2)
  reputationTier          BusinessTier               @default(BRONZE)
  createdAt               DateTime                   @default(now())
  updatedAt               DateTime                   @updatedAt

  ownerId        String
  owner          User         @relation(fields: [ownerId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  provinceId     String
  province       Province     @relation(fields: [provinceId], references: [id])
  cityId         String?
  city           City?        @relation(fields: [cityId], references: [id])

  categories            BusinessCategory[]
  images                BusinessImage[]
  reviews               Review[]
  features              BusinessFeature[]
  analytics             BusinessAnalytics[]
  promotions            Promotion[]
  bookings              Booking[]
  transactions          Transaction[]
  conversations         Conversation[]
  verificationDocuments BusinessVerificationDocument[]
  adCampaigns           AdCampaign[]

  @@index([slug])
  @@index([ownerId])
  @@index([organizationId])
  @@index([provinceId])
  @@index([latitude, longitude])
  @@index([verified])
  @@index([verified, createdAt])
  @@index([provinceId, verified, createdAt])
  @@index([verificationStatus, createdAt])
  @@index([provinceId, reputationScore])
  @@index([reputationTier, reputationScore])
  @@map("businesses")
}

model Organization {
  id                   String                         @id @default(uuid())
  name                 String                         @db.VarChar(150)
  slug                 String                         @unique @db.VarChar(180)
  ownerUserId          String
  ownerUser            User                           @relation("OrganizationOwner", fields: [ownerUserId], references: [id])
  plan                 OrganizationPlan               @default(FREE)
  subscriptionStatus   OrganizationSubscriptionStatus @default(ACTIVE)
  subscriptionRenewsAt DateTime?
  adWalletBalance      Decimal                        @default(0) @db.Decimal(12, 2)
  createdAt            DateTime                       @default(now())
  updatedAt            DateTime                       @updatedAt

  businesses            Business[]
  members               OrganizationMember[]
  invites               OrganizationInvite[]
  auditLogs             AuditLog[]
  subscription          Subscription?
  payments              Payment[]
  invoices              Invoice[]
  usageMetrics          UsageMetric[]
  promotions            Promotion[]
  bookings              Booking[]
  transactions          Transaction[]
  webhookEvents         WebhookEvent[]
  conversations         Conversation[]
  adCampaigns           AdCampaign[]
  verificationDocuments BusinessVerificationDocument[]
  adWalletTopups        AdWalletTopup[]

  @@index([ownerUserId])
  @@index([plan, subscriptionStatus])
  @@map("organizations")
}

model OrganizationMember {
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           OrganizationRole @default(STAFF)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@id([organizationId, userId])
  @@index([userId])
  @@map("organization_members")
}

model OrganizationInvite {
  id              String           @id @default(uuid())
  organizationId  String
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email           String           @db.VarChar(255)
  role            OrganizationRole @default(STAFF)
  tokenHash       String           @unique @db.VarChar(255)
  expiresAt       DateTime
  acceptedAt      DateTime?
  invitedByUserId String
  invitedByUser   User             @relation("OrganizationInvitedBy", fields: [invitedByUserId], references: [id])
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([organizationId])
  @@index([email])
  @@index([expiresAt])
  @@map("organization_invites")
}

model Plan {
  id                     String           @id @default(uuid())
  code                   OrganizationPlan @unique
  name                   String           @db.VarChar(80)
  description            String?          @db.Text
  priceMonthly           Decimal          @db.Decimal(12, 2)
  currency               String           @default("DOP") @db.VarChar(3)
  transactionFeeBps      Int              @default(0)
  maxBusinesses          Int?
  maxMembers             Int?
  maxImagesPerBusiness   Int?
  maxPromotions          Int?
  analyticsRetentionDays Int?
  active                 Boolean          @default(true)
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt

  subscriptions Subscription[]

  @@index([active, code])
  @@map("plans")
}

model Subscription {
  id                     String             @id @default(uuid())
  organizationId         String             @unique
  organization           Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  planId                 String
  plan                   Plan               @relation(fields: [planId], references: [id])
  status                 SubscriptionStatus @default(ACTIVE)
  providerCustomerId     String?            @db.VarChar(191)
  providerSubscriptionId String?            @unique @db.VarChar(191)
  currentPeriodStart     DateTime?
  currentPeriodEnd       DateTime?
  cancelAtPeriodEnd      Boolean            @default(false)
  canceledAt             DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  payments     Payment[]
  invoices     Invoice[]
  usageMetrics UsageMetric[]

  @@index([status, currentPeriodEnd])
  @@index([planId])
  @@map("subscriptions")
}

model Payment {
  id                      String        @id @default(uuid())
  organizationId          String
  organization            Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscriptionId          String?
  subscription            Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  provider                String        @default("stripe") @db.VarChar(40)
  providerPaymentIntentId String?       @unique @db.VarChar(191)
  amount                  Decimal       @db.Decimal(12, 2)
  currency                String        @default("DOP") @db.VarChar(3)
  status                  PaymentStatus @default(PENDING)
  paidAt                  DateTime?
  failureReason           String?       @db.VarChar(255)
  metadata                Json?
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt

  transactions Transaction[]

  @@index([organizationId, createdAt])
  @@index([subscriptionId, createdAt])
  @@index([status, createdAt])
  @@map("payments")
}

model Invoice {
  id                String        @id @default(uuid())
  organizationId    String
  organization      Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscriptionId    String?
  subscription      Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  providerInvoiceId String?       @unique @db.VarChar(191)
  number            String?       @unique @db.VarChar(120)
  amountSubtotal    Decimal       @db.Decimal(12, 2)
  amountTax         Decimal       @db.Decimal(12, 2)
  amountTotal       Decimal       @db.Decimal(12, 2)
  currency          String        @default("DOP") @db.VarChar(3)
  status            InvoiceStatus @default(OPEN)
  issuedAt          DateTime      @default(now())
  dueAt             DateTime?
  paidAt            DateTime?
  pdfUrl            String?       @db.VarChar(500)
  metadata          Json?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  transactions Transaction[]

  @@index([organizationId, issuedAt])
  @@index([subscriptionId, issuedAt])
  @@index([status, dueAt])
  @@map("invoices")
}

model UsageMetric {
  id             String        @id @default(uuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  metricKey      String        @db.VarChar(80)
  metricValue    Int
  periodStart    DateTime
  periodEnd      DateTime
  createdAt      DateTime      @default(now())

  @@unique([organizationId, metricKey, periodStart, periodEnd])
  @@index([organizationId, metricKey, periodStart])
  @@index([subscriptionId, metricKey])
  @@map("usage_metrics")
}

model AuditLog {
  id             String        @id @default(uuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  actorUserId    String?
  actorUser      User?         @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)
  action         String        @db.VarChar(120)
  targetType     String        @db.VarChar(80)
  targetId       String?       @db.VarChar(191)
  metadata       Json?
  createdAt      DateTime      @default(now())

  @@index([organizationId, createdAt])
  @@index([actorUserId, createdAt])
  @@index([action])
  @@map("audit_logs")
}

model Category {
  id   String  @id @default(uuid())
  name String  @unique @db.VarChar(100)
  slug String  @unique @db.VarChar(120)
  icon String? @db.VarChar(10)

  businesses          BusinessCategory[]
  adCampaignsTargeted AdCampaign[]       @relation("AdCampaignTargetCategory")

  @@index([slug])
  @@map("categories")
}

model BusinessCategory {
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([businessId, categoryId])
  @@index([categoryId])
  @@map("business_categories")
}

model Review {
  id               String                 @id @default(uuid())
  rating           Int                    @db.SmallInt
  comment          String?                @db.Text
  moderationStatus ReviewModerationStatus @default(APPROVED)
  moderationReason String?                @db.VarChar(255)
  flaggedAt        DateTime?
  isSpam           Boolean                @default(false)
  createdAt        DateTime               @default(now())

  userId     String
  user       User     @relation(fields: [userId], references: [id])
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
  @@index([businessId])
  @@index([userId])
  @@index([moderationStatus, createdAt])
  @@index([businessId, moderationStatus, isSpam, createdAt])
  @@map("reviews")
}

model BusinessImage {
  id  String @id @default(uuid())
  url String @db.VarChar(500)

  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@map("business_images")
}

model Province {
  id   String @id @default(uuid())
  name String @unique @db.VarChar(100)
  slug String @unique @db.VarChar(120)

  cities              City[]
  businesses          Business[]
  adCampaignsTargeted AdCampaign[] @relation("AdCampaignTargetProvince")

  @@index([slug])
  @@map("provinces")
}

model City {
  id   String @id @default(uuid())
  name String @db.VarChar(100)

  provinceId String
  province   Province @relation(fields: [provinceId], references: [id])

  businesses Business[]

  @@unique([provinceId, name])
  @@index([provinceId])
  @@map("cities")
}

model Feature {
  id   String @id @default(uuid())
  name String @unique @db.VarChar(100)

  businesses BusinessFeature[]

  @@map("features")
}

model BusinessFeature {
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  featureId  String
  feature    Feature  @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@id([businessId, featureId])
  @@map("business_features")
}

model BusinessAnalytics {
  id                  String   @id @default(uuid())
  businessId          String
  business            Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  date                DateTime @db.Date
  views               Int      @default(0)
  uniqueVisitors      Int      @default(0)
  clicks              Int      @default(0)
  conversions         Int      @default(0)
  reservationRequests Int      @default(0)
  grossRevenue        Decimal  @default(0) @db.Decimal(12, 2)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([businessId, date])
  @@index([date])
  @@map("business_analytics")
}

model Promotion {
  id               String       @id @default(uuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  businessId       String
  business         Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdByUserId  String?
  createdByUser    User?        @relation("PromotionCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  title            String       @db.VarChar(160)
  slug             String       @unique @db.VarChar(180)
  description      String?      @db.Text
  discountType     DiscountType
  discountValue    Decimal      @db.Decimal(10, 2)
  couponCode       String?      @unique @db.VarChar(80)
  startsAt         DateTime
  endsAt           DateTime
  maxRedemptions   Int?
  redemptionsCount Int          @default(0)
  isFlashOffer     Boolean      @default(false)
  isActive         Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  bookings     Booking[]
  transactions Transaction[]

  @@index([businessId, isActive, endsAt])
  @@index([organizationId, isActive])
  @@index([couponCode])
  @@map("promotions")
}

model Booking {
  id             String        @id @default(uuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  businessId     String
  business       Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  userId         String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  promotionId    String?
  promotion      Promotion?    @relation(fields: [promotionId], references: [id], onDelete: SetNull)
  status         BookingStatus @default(PENDING)
  source         BookingSource @default(PLATFORM)
  scheduledFor   DateTime
  partySize      Int?
  notes          String?       @db.Text
  quotedAmount   Decimal?      @db.Decimal(12, 2)
  depositAmount  Decimal?      @db.Decimal(12, 2)
  currency       String        @default("DOP") @db.VarChar(3)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  transactions        Transaction[]
  sourceConversations Conversation[]

  @@index([businessId, scheduledFor])
  @@index([organizationId, status])
  @@index([userId, createdAt])
  @@map("bookings")
}

model Transaction {
  id                String            @id @default(uuid())
  organizationId    String
  organization      Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  businessId        String
  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bookingId         String?
  booking           Booking?          @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  promotionId       String?
  promotion         Promotion?        @relation(fields: [promotionId], references: [id], onDelete: SetNull)
  buyerUserId       String?
  buyerUser         User?             @relation("TransactionBuyer", fields: [buyerUserId], references: [id], onDelete: SetNull)
  paymentId         String?
  payment           Payment?          @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  invoiceId         String?
  invoice           Invoice?          @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  grossAmount       Decimal           @db.Decimal(12, 2)
  platformFeeAmount Decimal           @db.Decimal(12, 2)
  netAmount         Decimal           @db.Decimal(12, 2)
  currency          String            @default("DOP") @db.VarChar(3)
  status            TransactionStatus @default(PENDING)
  providerReference String?           @db.VarChar(191)
  paidAt            DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([organizationId, createdAt])
  @@index([businessId, createdAt])
  @@index([status, createdAt])
  @@index([paymentId])
  @@map("transactions")
}

model WebhookEvent {
  id               String                  @id @default(uuid())
  organizationId   String?
  organization     Organization?           @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  provider         WebhookProvider         @default(STRIPE)
  externalEventId  String                  @db.VarChar(191)
  eventType        String                  @db.VarChar(120)
  processingStatus WebhookProcessingStatus @default(RECEIVED)
  signature        String?                 @db.VarChar(500)
  payload          Json
  errorMessage     String?                 @db.VarChar(500)
  receivedAt       DateTime                @default(now())
  processedAt      DateTime?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  @@unique([provider, externalEventId])
  @@index([processingStatus, receivedAt])
  @@index([organizationId, receivedAt])
  @@map("webhook_events")
}

model RefreshToken {
  id             String    @id @default(uuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash      String    @unique @db.VarChar(255)
  expiresAt      DateTime
  revokedAt      DateTime?
  replacedByHash String?   @db.VarChar(255)
  userAgent      String?   @db.VarChar(255)
  ipAddress      String?   @db.VarChar(120)
  createdAt      DateTime  @default(now())

  @@index([userId, expiresAt])
  @@index([revokedAt])
  @@map("refresh_tokens")
}

model Conversation {
  id                 String             @id @default(uuid())
  organizationId     String
  organization       Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  businessId         String
  business           Business           @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customerUserId     String
  customerUser       User               @relation("ConversationCustomer", fields: [customerUserId], references: [id], onDelete: Cascade)
  subject            String?            @db.VarChar(160)
  status             ConversationStatus @default(OPEN)
  lastMessageAt      DateTime           @default(now())
  convertedBookingId String?            @unique
  convertedBooking   Booking?           @relation(fields: [convertedBookingId], references: [id], onDelete: SetNull)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  messages ConversationMessage[]

  @@index([organizationId, status, lastMessageAt])
  @@index([businessId, status, lastMessageAt])
  @@index([customerUserId, status, lastMessageAt])
  @@map("conversations")
}

model ConversationMessage {
  id             String            @id @default(uuid())
  conversationId String
  conversation   Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderUserId   String?
  senderUser     User?             @relation("ConversationMessageSender", fields: [senderUserId], references: [id], onDelete: SetNull)
  senderRole     MessageSenderRole
  content        String            @db.Text
  createdAt      DateTime          @default(now())
  readAt         DateTime?

  @@index([conversationId, createdAt])
  @@index([senderUserId, createdAt])
  @@map("conversation_messages")
}

model BusinessVerificationDocument {
  id               String                     @id @default(uuid())
  organizationId   String
  organization     Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  businessId       String
  business         Business                   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  documentType     VerificationDocumentType
  fileUrl          String                     @db.VarChar(500)
  status           VerificationDocumentStatus @default(PENDING)
  reviewedByUserId String?
  reviewedByUser   User?                      @relation("VerificationDocumentReviewer", fields: [reviewedByUserId], references: [id], onDelete: SetNull)
  rejectionReason  String?                    @db.VarChar(500)
  submittedAt      DateTime                   @default(now())
  reviewedAt       DateTime?
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt

  @@index([organizationId, status, submittedAt])
  @@index([businessId, status])
  @@index([reviewedByUserId, reviewedAt])
  @@map("business_verification_documents")
}

model AdCampaign {
  id               String           @id @default(uuid())
  organizationId   String
  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  businessId       String
  business         Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdByUserId  String?
  createdByUser    User?            @relation("AdCampaignCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  name             String           @db.VarChar(160)
  status           AdCampaignStatus @default(DRAFT)
  billingModel     AdBillingModel   @default(CPC)
  targetProvinceId String?
  targetProvince   Province?        @relation("AdCampaignTargetProvince", fields: [targetProvinceId], references: [id], onDelete: SetNull)
  targetCategoryId String?
  targetCategory   Category?        @relation("AdCampaignTargetCategory", fields: [targetCategoryId], references: [id], onDelete: SetNull)
  dailyBudget      Decimal          @db.Decimal(12, 2)
  totalBudget      Decimal          @db.Decimal(12, 2)
  bidAmount        Decimal          @db.Decimal(10, 2)
  spentAmount      Decimal          @default(0) @db.Decimal(12, 2)
  impressions      Int              @default(0)
  clicks           Int              @default(0)
  conversions      Int              @default(0)
  startsAt         DateTime
  endsAt           DateTime
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  events AdEvent[]

  @@index([organizationId, status, startsAt, endsAt])
  @@index([businessId, status])
  @@index([targetProvinceId, targetCategoryId, status])
  @@map("ad_campaigns")
}

model AdEvent {
  id          String      @id @default(uuid())
  campaignId  String
  campaign    AdCampaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  eventType   AdEventType
  visitorHash String?     @db.VarChar(64)
  costAmount  Decimal     @default(0) @db.Decimal(12, 2)
  metadata    Json?
  occurredAt  DateTime    @default(now())

  @@index([campaignId, eventType, occurredAt])
  @@index([occurredAt])
  @@map("ad_events")
}

model MarketReportSnapshot {
  id                String           @id @default(uuid())
  reportType        MarketReportType
  periodStart       DateTime
  periodEnd         DateTime
  filters           Json?
  summary           Json
  generatedByUserId String?
  generatedByUser   User?            @relation("MarketReportGeneratedBy", fields: [generatedByUserId], references: [id], onDelete: SetNull)
  generatedAt       DateTime         @default(now())

  @@index([reportType, generatedAt])
  @@index([generatedByUserId, generatedAt])
  @@map("market_report_snapshots")
}

model AdWalletTopup {
  id                        String              @id @default(uuid())
  organizationId            String
  organization              Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requestedByUserId         String?
  requestedByUser           User?               @relation("AdWalletTopupRequester", fields: [requestedByUserId], references: [id], onDelete: SetNull)
  provider                  String              @default("stripe") @db.VarChar(40)
  amount                    Decimal             @db.Decimal(12, 2)
  currency                  String              @default("DOP") @db.VarChar(3)
  status                    AdWalletTopupStatus @default(PENDING)
  providerCheckoutSessionId String?             @unique @db.VarChar(191)
  providerPaymentIntentId   String?             @unique @db.VarChar(191)
  paidAt                    DateTime?
  failureReason             String?             @db.VarChar(255)
  metadata                  Json?
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt

  @@index([organizationId, createdAt])
  @@index([status, createdAt])
  @@index([requestedByUserId, createdAt])
  @@map("ad_wallet_topups")
}
